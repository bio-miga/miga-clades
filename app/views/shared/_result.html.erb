<% unless key.nil? or key==:stats %>
<div class="result">

<%
  titles = {
    ssu: "Ribosomal RNA (small subunit)",
    cds: "Gene prediction",
    mytaxa_scan: "MyTaxa Scan",
    haai_distances: "hAAI distances",
    aai_distances: "AAI distances",
    ani_distances: "ANI distances",
    ogs: "Orthologous groups of proteins"
  }
  if obj.is_a? Project
    proj = obj
  elsif not obj.is_a? MiGA::Dataset
    proj = obj.project
  end
%>

<h3>
  <i class="glyphicon glyphicon-tasks" id="result-<%= key %>"> </i>
  <%= titles[key].nil? ? key.to_s.gsub("_", " ").capitalize : titles[key] %>
</h3>

<div class="result-body">
  <% case key %>
  <% # Dataset results %>
  <% when :read_quality %>
    <p>FastQC reports:</p>
    <ul>
    <% Dir.new(res.file_path :fastqc).each_entry do |f| %>
      <% next unless f =~ /\.html/ %>
      <li>
      <%= link_to f, obj.is_a?(MiGA::Dataset) ?
          reference_dataset_result_path(proj.id, obj.name,
            :read_quality, :fastqc, f:f) :
          query_dataset_result_path(obj.id, :read_quality, :fastqc, f:f) %>
      </li>
    <% end %>
    </ul>
  <% when :essential_genes %>
    <%= render partial: "shared/results/essential_genes",
         locals: { res: res, job: key, project: proj } %>
  <% when :ssu %>
    <%= render partial: "shared/results/ssu",
         locals: { res: res, job: key, project: proj, obj: obj } %>
  <% when :mytaxa_scan %>
    <%
      f_path = obj.is_a?(MiGA::Dataset) ?
        reference_dataset_result_path(proj.id, obj.name,
          :mytaxa_scan, :report) :
        query_dataset_result_path(obj.id, :mytaxa_scan, :report)
      regions = res.data[:files][:region_ids].nil? ? 0 :
        File.readlines(res.file_path :region_ids).count
    %>
    <p>
      MyTaxa Scan detected <%= pluralize regions, "region" %> with unusual
      taxonomic distribution (<%= link_to "download PDF", f_path %>).
    </p>
  <% when :distances %>
    <%= render partial: "shared/results/distances",
         locals: { res: res, job: key, project: proj, dataset: obj } %>
  <% # Project-wide results %>
  <% when :haai_distances %>
    <p>Average Identity between sets of conserved proteins in Bacteria and
      Archaea, as a heuristic approximation to AAI.</p>
    <%= plot_distances(res.file_path(:hist), {},
        {height:300, title:"Distribution of hAAI values"}) unless
        res.data[:files][:hist].nil? %>
  <% when :aai_distances %>
    <p>Average Amino acid Identity between genomes.</p>
    <%= plot_distances(res.file_path(:hist), {},
        {height:300, title:"Distribution of AAI values"}) unless
        res.data[:files][:hist].nil? %>
  <% when :ani_distances %>
    <p>Average Nucleotide Identity between genomes with AAI &ge; 90%.</p>
    <%= plot_distances(res.file_path(:hist), {},
        {height:300, title:"Distribution of ANI values"}) unless
        res.data[:files][:hist].nil? %>
  <% when :clade_finding %>
    <%= render partial: "shared/results/clade_tree",
         locals: { res: res, job: key, project: proj } %>
    <%= render partial: "shared/results/proposed_clades",
         locals: { res: res, job: key, project: proj } %>
  <% when :subclades %>
    <%= render partial: "shared/results/clade_tree",
         locals: { res: res, job: key, project: proj } %>
  <% when :ogs %>
    <% unless res.data[:files][:stats].nil? %>
      <% stats = JSON.parse(File.read(res.file_path :stats),
          symbolize_names:true) %>
      <% knames = {pan: "Pangenome", core: "Core genome (100%)",
          core90pc: "Core genome (90%)", core80pc: "Core genome (80%)",
          avg: "Average genome", avg_pan: "Average/Pangenome",
          core_avg: "Core/Average", core_pan: "Core/Pangenome",
          ogs_shannon: "Average Information Content"} %>
      <p>MiGA found <%= stats[:pan] %> groups of orthology in
        <%= stats[:genomes] %> genomes with the following statistics:</p>
      <ul class="list-group" style="margin:15px;">
        <% stats.each do |k,v| %>
          <li class="list-group-item row">
            <div class="col-md-6" style="text-align:right;"><b><%=
              (knames[k] || k.to_s.gsub("_","/")).capitalize %></b></div>
            <div class="col-md-6"><%= v %></div>
          </li>
        <% end %>
      </ul>
    <% end %>
  <% end %>
  <% unless res[:stats].nil? or res[:stats].empty? %>
    <p>
    <% res[:stats].each do |k,v| %>
      <% v = v.is_a?(Array) ? [v[0], " #{v[1]}"] : [v, ""] %>
      <b><%= k.to_s.unmiga_name.capitalize %>:</b>
      <%= number_with_precision(v[0],
            precision:4, strip_insignificant_zeros:true, delimiter:",")
            %><%= v[1] %>.<br/>
    <% end %>
    </p>
  <% end %>
</div>

<div class="result-footer">
  <i class="glyphicon glyphicon-download" title="downloads"> </i>
  <%=
    res.data[:files].keys.map do |k|
      f = res.file_path(k)
      next unless File.size? f
      link_to(k, obj.is_a?(Project) ?
        project_result_path(obj.id, key, k) :
        obj.is_a?(MiGA::Dataset) ?
        reference_dataset_result_path(proj.id, obj.name, key, k) :
        query_dataset_result_path(obj.id, key, k), {rel: "tooltip",
        title: Dir.exist?(f) ? "Folder" : number_to_human_size(File.size f)})
    end.compact.
      to_sentence(two_words_connector:" or ", last_word_connector:", or ").
      html_safe
  %>
  <div class="timestamp"><%= time_ago_in_words res.data[:created] %> ago</div>
</div>
</div>
<% end %>
